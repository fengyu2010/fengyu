-- Robloxè·¨å¹³å°å¨±ä¹è¾…åŠ©è„šæœ¬ï¼ˆå®Œæ•´ç‰ˆï¼‰
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ é…ç½®åŒºåŸŸ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local LOCK_KEY = Enum.KeyCode.RightShift    -- PCè§¦å‘é”®
local TARGET_PART = "Head"                  -- ç„å‡†éƒ¨ä½
local ACTIVATE_RADIUS = 100                 -- ç§»åŠ¨ç«¯è§¦æ§åŠå¾„
local GAMEPAD_TRIGGER = Enum.KeyCode.ButtonL2 -- æ‰‹æŸ„å·¦æ‰³æœº
local TRIGGER_THRESHOLD = 0.3               -- æ‰³æœºè§¦å‘é˜ˆå€¼

-- åŠ¨æ€å¹³æ»‘é…ç½®
local DYNAMIC_SMOOTHING = {
    Enabled = true,        -- å¯ç”¨è·ç¦»åŠ¨æ€å¹³æ»‘
    MinDistance = 10,      -- æœ€å°é”å®šè·ç¦»ï¼ˆç±³ï¼‰
    MaxDistance = 50,      -- æœ€å¤§é”å®šè·ç¦»ï¼ˆç±³ï¼‰
    CloseSmooth = 0.15,    -- è¿‘è·ç¦»å¹³æ»‘ç³»æ•°
    FarSmooth = 0.4,       -- è¿œè·ç¦»å¹³æ»‘ç³»æ•°
    CurveFactor = 2.5      -- å¹³æ»‘è¿‡æ¸¡æ›²çº¿å¼ºåº¦
}

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ åˆå§‹åŒ– â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera
local target = nil
local currentSmoothness = DYNAMIC_SMOOTHING.CloseSmooth

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ UIç³»ç»Ÿ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimAssistUI"
screenGui.Parent = localPlayer:WaitForChild("PlayerGui")

-- åŠ¨æ€æ•™ç¨‹æ¡†æ¶
local tutorialFrame = Instance.new("Frame")
tutorialFrame.Size = UDim2.new(0.35, 0, 0.25, 0)
tutorialFrame.Position = UDim2.new(0.65, 0, 0.7, 0)
tutorialFrame.BackgroundTransparency = 0.8
tutorialFrame.Visible = false

local hintTexts = {
    Mobile = "ğŸ“± é•¿æŒ‰å³ä¾§åŒºåŸŸé”å®šç›®æ ‡",
    Gamepad = "ğŸ® æŒ‰ä½å·¦æ‰³æœº(LT)é”å®š+å‹åŠ›æ„Ÿåº”",
    Desktop = "ğŸ–±ï¸ æŒ‰ä½å³é”®æ‹–åŠ¨ç„å‡†"
}

local deviceHint = Instance.new("TextLabel")
deviceHint.Text = "è®¾å¤‡æ£€æµ‹ä¸­..."
deviceHint.TextColor3 = Color3.new(1,1,1)
deviceHint.Size = UDim2.new(1, 0, 1, 0)
deviceHint.Font = Enum.Font.GothamMedium
deviceHint.Parent = tutorialFrame
screenGui.Parent = tutorialFrame

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ è®¾å¤‡æ£€æµ‹ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local function getDeviceType()
    if UIS.TouchEnabled then return "Mobile" end
    if UIS:GetLastInputType().Name:find("Gamepad") then return "Gamepad" end
    return "Desktop"
end

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ç›®æ ‡é”å®šç³»ç»Ÿ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local function getValidTargets()
    local targets = {}
    -- æ­¤å¤„æ’å…¥ä¹‹å‰ç‰ˆæœ¬çš„ç›®æ ‡ç­›é€‰é€»è¾‘
    return targets
end

local function findBestTarget()
    local closest = nil
    local minDistance = math.huge
    for _, targetData in ipairs(getValidTargets()) do
        local distance = (targetData.ScreenPos - camera.ViewportSize/2).Magnitude
        if distance < minDistance then
            closest = targetData
            minDistance = distance
        end
    end
    return closest
end

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ è¾“å…¥å¤„ç†ç³»ç»Ÿ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
-- ç§»åŠ¨ç«¯è§¦æ§
local activeTouchId = nil
local touchFrame = Instance.new("Frame")
touchFrame.Size = UDim2.new(0.3, 0, 0.6, 0)
touchFrame.BackgroundTransparency = 1
touchFrame.Parent = screenGui

UIS.TouchStarted:Connect(function(touch)
    if getDeviceType() ~= "Mobile" then return end
    local center = touchFrame.AbsolutePosition + touchFrame.AbsoluteSize/2
    if (touch.Position - center).Magnitude < ACTIVATE_RADIUS then
        activeTouchId = touch.UserInputType
        target = findBestTarget()
    end
end)

UIS.TouchEnded:Connect(function(touch)
    if touch.UserInputType == activeTouchId then
        target = nil
        activeTouchId = nil
    end
end)

-- æ‰‹æŸ„è¾“å…¥
UIS.InputChanged:Connect(function(input)
    if getDeviceType() ~= "Gamepad" then return end
    if input.UserInputType == Enum.UserInputType.Gamepad1 then
        if input.KeyCode == GAMEPAD_TRIGGER then
            local triggerValue = input.Position.Z
            if triggerValue > TRIGGER_THRESHOLD then
                target = target or findBestTarget()
                currentSmoothness = DYNAMIC_SMOOTHING.CloseSmooth * 
                    (1 - (triggerValue - TRIGGER_THRESHOLD)/(1 - TRIGGER_THRESHOLD)*0.5)
            else
                target = nil
            end
        end
    end
end)

-- PCè¾“å…¥
UIS.InputBegan:Connect(function(input)
    if getDeviceType() == "Desktop" then
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            target = findBestTarget()
        end
    end
end)

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ åŠ¨æ€å¹³æ»‘ç³»ç»Ÿ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local function calculateDynamicSmoothness(targetPos)
    if not DYNAMIC_SMOOTHING.Enabled then return currentSmoothness end
    local distance = (targetPos - camera.CFrame.Position).Magnitude
    distance = math.clamp(distance, DYNAMIC_SMOOTHING.MinDistance, DYNAMIC_SMOOTHING.MaxDistance)
    local t = (distance - DYNAMIC_SMOOTHING.MinDistance) / 
             (DYNAMIC_SMOOTHING.MaxDistance - DYNAMIC_SMOOTHING.MinDistance)
    return DYNAMIC_SMOOTHING.CloseSmooth + 
           (DYNAMIC_SMOOTHING.FarSmooth - DYNAMIC_SMOOTHING.CloseSmooth) * 
           math.pow(t, DYNAMIC_SMOOTHING.CurveFactor)
end

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ç„å‡†å¼•æ“ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
local function smoothAim(targetPos)
    local dynamicSmooth = calculateDynamicSmoothness(targetPos)
    local targetCFrame = CFrame.lookAt(camera.CFrame.Position, targetPos)
    camera.CFrame = camera.CFrame:Lerp(targetCFrame, dynamicSmooth)
end

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ä¸»å¾ªç¯ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
RunService.Heartbeat:Connect(function()
    -- æ›´æ–°UIæç¤º
    local deviceType = getDeviceType()
    tutorialFrame.Visible = true
    deviceHint.Text = hintTexts[deviceType]

    -- ç›®æ ‡æœ‰æ•ˆæ€§æ£€æŸ¥
    if target and not target.Part:IsDescendantOf(workspace) then
        target = nil
    end

    -- æ‰§è¡Œç„å‡†
    if target then
        smoothAim(target.Part.Position)
    end
end)

--â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ å®‰å…¨è­¦å‘Š â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
warn([[âš  æœ¬è„šæœ¬ä»…é™ç§äººæœåŠ¡å™¨å¨±ä¹ä½¿ç”¨ï¼
ç¦æ­¢åœ¨å…¬å¼€æ¸¸æˆä¸­ä½¿ç”¨ï¼]])